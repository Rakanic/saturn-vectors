
#include <stdio.h>
#include <riscv-pk/encoding.h>
#include <riscv_vector.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

// HACK reuse the scalar registers to avoid assembler hacking for now
#define m0 "x0"
#define m1 "x1"
#define m2 "x2"
#define m3 "x3"
#define m4 "x4"
#define m5 "x5"
#define m6 "x6"
#define m7 "x7"

#define v0 "x0"
#define v1 "x1"
#define v2 "x2"
#define v3 "x3"
#define v4 "x4"
#define v5 "x5"
#define v6 "x6"
#define v7 "x7"
#define v8 "x8"
#define v9 "x9"
#define v10 "x10"
#define v11 "x11"
#define v12 "x12"
#define v13 "x13"
#define v14 "x14"
#define v15 "x15"
#define v16 "x16"
#define v17 "x17"
#define v18 "x18"
#define v19 "x19"
#define v20 "x20"
#define v21 "x21"
#define v22 "x22"
#define v23 "x23"
#define v24 "x24"
#define v25 "x25"
#define v26 "x26"
#define v27 "x27"
#define v28 "x28"
#define v29 "x29"
#define v30 "x30"
#define v31 "x31"

#define VLEN 16
#define MIN 1
#define MAX 39
#define STEP 12

// opmvx. f6=b101010, f7=b1010101
#define OPMVIN(md, vs2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x55, " md ", %0, " vs2 : : "r"(rs1));

// opmvx. f6=b101110, f7=b1011101
#define OPMVOUT(vd, ms2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x5d, " vd ", %0, " ms2 : : "r"(rs1));

// opmvx. f6=b101100, f7=b1011001
#define OPMVINBCAST(md, vs2) \
  asm volatile(".insn r 0x57, 0x6, 0x59, " md ", x0, " vs2);

// opmvv. f6=b101000, f7=b1010001 
#define OPMACC(md, vs2, vs1) \
  asm volatile(".insn r 0x57, 0x2, 0x51, " md ", " vs1 ", " vs2);


void fp8_opu_simple(int8_t* vecA, int8_t* vecB, int32_t* result, size_t vec_size, int32_t bias) {
	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
	asm volatile("vmv.v.i v0, 0x0");
	OPMVINBCAST(m1, v0);

	asm volatile("vmv.v.x v0, %[value_bias]" : : [value_bias]"r"(bias));
	for (size_t r = 0; r < vec_size; r++) {
		OPMVIN(m1, v0, r);
	}
	
	asm volatile("vsetvli %[vl], %[vl], e8, m1, ta, ma" : : [vl]"r"(vec_size));
        asm volatile("vle8.v v1, (%0)" : : "r"(vecA));
        asm volatile("vle8.v v0, (%0)" : : "r"(vecB));
        OPMACC(m1, v1, v0);
        OPMACC(m1, v1, v0);
        OPMACC(m1, v1, v0);
        OPMACC(m1, v1, v0);
        OPMACC(m1, v1, v0);
        OPMACC(m1, v1, v0);

	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
      	for (size_t r = 0; r < vec_size; r++) {
		OPMVOUT(v0, m1, r);
		asm volatile("vse32.v v0, (%0)" : : "r"(&result[r*vec_size]));
	}
}	

void fp8_matmul_simple(int8_t* At, int8_t* B, int32_t* C, int32_t* bias, size_t vec_size) {
	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
	asm volatile("vmv.v.i v0, 0x0");
	OPMVINBCAST(m1, v0);

	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
	for (size_t r = 0; r < vec_size; r++) {
		asm volatile("vle32.v v1, (%0)" : : "r"(bias+r*vec_size));
		OPMVIN(m1, v1, r);
	}

	asm volatile("vsetvli %[vl], %[vl], e8, m1, ta, ma" : : [vl]"r"(vec_size));
	for (int k = 0; k < vec_size; k++) {
		asm volatile("vle8.v v1, (%0)" : : "r"(At+k*vec_size));
		asm volatile("vle8.v v0, (%0)" : : "r"(B+k*vec_size));
		OPMACC(m1, v1, v0);
	}

	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
      	for (size_t r = 0; r < vec_size; r++) {
		OPMVOUT(v0, m1, r);
		asm volatile("vse32.v v0, (%0)" : : "r"(&C[r*vec_size]));
	}

}

int main(void) {

  int8_t A[VLEN] = {-72, -74, -76, -78, -81, -85, -91, -103, 25, 37, 43, 47, 50, 52, 54, 56};
  int8_t B[VLEN] = {56, 54, 52, 50, 47, 43, 37, 25, -103, -91, -85, -81, -78, -76, -74, -72};
  int32_t C[VLEN*VLEN];
  int32_t CGold[VLEN*VLEN] = {
	     -1064304640,-1066401792,-1069547520,-1072693248,-1079508992,-1089470464, 1049624576, 1066008576, 1073086464, 1076756480, 1080295424, 1082785792, 1084751872, 1086324736, 1087897600, 1089470464 ,
   -1066401792,-1069154304,-1071906816,-1075576832,-1082785792,-1097072640, 1054736384, 1066450944, 1072644096, 1076117504, 1079214080, 1081966592, 1083768832, 1085145088, 1086521344, 1087897600 ,
   -1069547520,-1071906816,-1074790400,-1079508992,-1088684032,-1119879168, 1058406400, 1066893312, 1072201728, 1075478528, 1078132736, 1080492032, 1082785792, 1083965440, 1085145088, 1086324736 ,
   -1072693248,-1075576832,-1079508992,-1084751872,-1098645504, 1045954560, 1060962304, 1067335680, 1071759360, 1074839552, 1077051392, 1079017472, 1081475072, 1082785792, 1083768832, 1084751872 ,
   -1079508992,-1082785792,-1088684032,-1098645504, 1043988480, 1057521664, 1064157184, 1067888640, 1071206400, 1074040832, 1075699712, 1077174272, 1079017472, 1080492032, 1081966592, 1082785792 ,
   -1089470464,-1097072640,-1119879168, 1045954560, 1057521664, 1061847040, 1066033152, 1068331008, 1070764032, 1073061888, 1074618368, 1075699712, 1077051392, 1078132736, 1079214080, 1080295424 ,
    1049624576, 1054736384, 1058406400, 1060962304, 1064157184, 1066033152, 1067470848, 1068828672, 1070266368, 1071624192, 1073061888, 1074040832, 1074839552, 1075478528, 1076117504, 1076756480 ,
    1066008576, 1066450944, 1066893312, 1067335680, 1067888640, 1068331008, 1068828672, 1069298688, 1069796352, 1070266368, 1070764032, 1071206400, 1071759360, 1072201728, 1072644096, 1073086464 ,
    1073086464, 1072644096, 1072201728, 1071759360, 1071206400, 1070764032, 1070266368, 1069796352, 1069298688, 1068828672, 1068331008, 1067888640, 1067335680, 1066893312, 1066450944, 1066008576 ,
    1076756480, 1076117504, 1075478528, 1074839552, 1074040832, 1073061888, 1071624192, 1070266368, 1068828672, 1067470848, 1066033152, 1064157184, 1060962304, 1058406400, 1054736384, 1049624576 ,
    1080295424, 1079214080, 1078132736, 1077051392, 1075699712, 1074618368, 1073061888, 1070764032, 1068331008, 1066033152, 1061847040, 1057521664, 1045954560,-1119879168,-1097072640,-1089470464 ,
    1082785792, 1081966592, 1080492032, 1079017472, 1077174272, 1075699712, 1074040832, 1071206400, 1067888640, 1064157184, 1057521664, 1043988480,-1098645504,-1088684032,-1082785792,-1079508992 ,
    1084751872, 1083768832, 1082785792, 1081475072, 1079017472, 1077051392, 1074839552, 1071759360, 1067335680, 1060962304, 1045954560,-1098645504,-1084751872,-1079508992,-1075576832,-1072693248 ,
    1086324736, 1085145088, 1083965440, 1082785792, 1080492032, 1078132736, 1075478528, 1072201728, 1066893312, 1058406400,-1119879168,-1088684032,-1079508992,-1074790400,-1071906816,-1069547520 ,
    1087897600, 1086521344, 1085145088, 1083768832, 1081966592, 1079214080, 1076117504, 1072644096, 1066450944, 1054736384,-1097072640,-1082785792,-1075576832,-1071906816,-1069154304,-1066401792 ,
    1089470464, 1087897600, 1086324736, 1084751872, 1082785792, 1080295424, 1076756480, 1073086464, 1066008576, 1049624576,-1089470464,-1079508992,-1072693248,-1069547520,-1066401792,-1064304640
  };

  fp8_opu_simple(A, B, C, VLEN, 0x3fc00000);

  for (int i = 0; i < VLEN; i ++) {
	for (int j = 0; j < VLEN; j ++) {
		int idx = i*VLEN + j;
		if (C[idx] != CGold[idx]) {
			printf("Mismatch at index %d. Expected %d, but got %d\n", idx, CGold[idx], C[idx]);
		}
	}
  }
	
  printf("Test OP DONE! \n");

  int8_t At [VLEN*VLEN] = {
	  -72, -74, -76, -78, -80, -84, -88, -96, 2, 32, 40, 44, 48, 50, 52, 54 ,
   -72, -74, -76, -78, -80, -84, -89, -97, 6, 33, 40, 44, 48, 50, 52, 54 ,
   -72, -74, -76, -78, -81, -85, -89, -98, 10, 33, 41, 45, 48, 50, 52, 54 ,
   -72, -74, -76, -78, -81, -85, -90, -99, 14, 34, 41, 45, 48, 50, 52, 54 ,
   -73, -75, -77, -79, -81, -85, -90, -100, 17, 34, 41, 45, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -81, -85, -91, -101, 19, 35, 41, 45, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -82, -86, -91, -102, 21, 35, 42, 46, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -82, -86, -92, -103, 23, 36, 42, 46, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -82, -86, -92, -105, 25, 36, 42, 46, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -82, -86, -93, -107, 26, 37, 42, 46, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -83, -87, -93, -109, 27, 37, 43, 47, 49, 51, 53, 55 ,
   -73, -75, -77, -79, -83, -87, -94, -111, 28, 38, 43, 47, 49, 51, 53, 55 ,
   -74, -76, -78, -80, -83, -87, -94, -114, 29, 38, 43, 47, 50, 52, 54, 56 ,
   -74, -76, -78, -80, -83, -87, -95, -118, 30, 39, 43, 47, 50, 52, 54, 56 ,
   -74, -76, -78, -80, -84, -88, -95, -122, 31, 39, 44, 48, 50, 52, 54, 56 ,
   -74, -76, -78, -80, -84, -88, -96, -126, 32, 40, 44, 48, 50, 52, 54, 56
  };

  int8_t Bmat [VLEN*VLEN] = {
	   56, 54, 52, 50, 48, 44, 40, 32, -126, -96, -88, -84, -80, -78, -76, -74 ,
   56, 54, 52, 50, 48, 44, 39, 31, -122, -95, -88, -84, -80, -78, -76, -74 ,
   56, 54, 52, 50, 47, 43, 39, 30, -118, -95, -87, -83, -80, -78, -76, -74 ,
   56, 54, 52, 50, 47, 43, 38, 29, -114, -94, -87, -83, -80, -78, -76, -74 ,
   55, 53, 51, 49, 47, 43, 38, 28, -111, -94, -87, -83, -79, -77, -75, -73 ,
   55, 53, 51, 49, 47, 43, 37, 27, -109, -93, -87, -83, -79, -77, -75, -73 ,
   55, 53, 51, 49, 46, 42, 37, 26, -107, -93, -86, -82, -79, -77, -75, -73 ,
   55, 53, 51, 49, 46, 42, 36, 25, -105, -92, -86, -82, -79, -77, -75, -73 ,
   55, 53, 51, 49, 46, 42, 36, 23, -103, -92, -86, -82, -79, -77, -75, -73 ,
   55, 53, 51, 49, 46, 42, 35, 21, -102, -91, -86, -82, -79, -77, -75, -73 ,
   55, 53, 51, 49, 45, 41, 35, 19, -101, -91, -85, -81, -79, -77, -75, -73 ,
   55, 53, 51, 49, 45, 41, 34, 17, -100, -90, -85, -81, -79, -77, -75, -73 ,
   54, 52, 50, 48, 45, 41, 34, 14, -99, -90, -85, -81, -78, -76, -74, -72 ,
   54, 52, 50, 48, 45, 41, 33, 10, -98, -89, -85, -81, -78, -76, -74, -72 ,
   54, 52, 50, 48, 44, 40, 33, 6, -97, -89, -84, -80, -78, -76, -74, -72 ,
   54, 52, 50, 48, 44, 40, 32, 2, -96, -88, -84, -80, -78, -76, -74, -72	
  };

  int32_t bias [VLEN * VLEN];
  for (int i = 0; i < VLEN*VLEN; i ++) bias[i] = 0x3fc00000;
  int32_t C2 [VLEN*VLEN];
  int32_t CGold2 [VLEN*VLEN] = {
	-1052147712,-1054113792,-1056079872,-1059127296,-1063075840,-1068662784,-1079312384, 1057112064, 1075597312, 1082736640, 1086668800, 1090560000, 1092517888, 1094483968, 1096450048, 1098416128 ,
   -1054113792,-1055817728,-1058078720,-1061486592,-1064910848,-1071284224,-1082785792, 1059274752, 1075056640, 1081769984, 1085358080, 1088765952, 1091338240, 1093042176, 1094746112, 1096450048 ,
   -1056079872,-1058078720,-1060962304,-1063845888,-1068138496,-1074069504,-1089077248, 1061437440, 1074515968, 1080197120, 1084047360, 1086930944, 1089798144, 1091600384, 1093042176, 1094483968 ,
   -1059127296,-1061486592,-1063845888,-1067057152,-1071808512,-1079312384,-1101529088, 1063600128, 1073975296, 1078624256, 1082736640, 1085095936, 1087438848, 1089798144, 1091338240, 1092517888 ,
   -1063075840,-1064910848,-1068138496,-1071808512,-1077215232,-1086980096, 1042939904, 1065574400, 1073143808, 1077059584, 1080721408, 1083260928, 1085095936, 1086930944, 1088765952, 1090560000 ,
   -1068662784,-1071284224,-1074069504,-1079312384,-1086980096,-1112539136, 1057652736, 1066655744, 1072062464, 1075486720, 1078099968, 1080721408, 1082736640, 1084047360, 1085358080, 1086668800 ,
   -1079312384,-1082785792,-1089077248,-1101529088, 1042939904, 1057652736, 1063944192, 1067741184, 1070985216, 1073913856, 1075486720, 1077059584, 1078624256, 1080197120, 1081769984, 1082736640 ,
    1057112064, 1059274752, 1061437440, 1063600128, 1065574400, 1066655744, 1067741184, 1068798976, 1069914112, 1070985216, 1072062464, 1073143808, 1073975296, 1074515968, 1075056640, 1075597312 ,
    1075597312, 1075056640, 1074515968, 1073975296, 1073143808, 1072062464, 1070985216, 1069914112, 1068798976, 1067741184, 1066655744, 1065574400, 1063600128, 1061437440, 1059274752, 1057112064 ,
    1082736640, 1081769984, 1080197120, 1078624256, 1077059584, 1075486720, 1073913856, 1070985216, 1067741184, 1063944192, 1057652736, 1042939904,-1101529088,-1089077248,-1082785792,-1079312384 ,
    1086668800, 1085358080, 1084047360, 1082736640, 1080721408, 1078099968, 1075486720, 1072062464, 1066655744, 1057652736,-1112539136,-1086980096,-1079312384,-1074069504,-1071284224,-1068662784 ,
    1090560000, 1088765952, 1086930944, 1085095936, 1083260928, 1080721408, 1077059584, 1073143808, 1065574400, 1042939904,-1086980096,-1077215232,-1071808512,-1068138496,-1064910848,-1063075840 ,
    1092517888, 1091338240, 1089798144, 1087438848, 1085095936, 1082736640, 1078624256, 1073975296, 1063600128,-1101529088,-1079312384,-1071808512,-1067057152,-1063845888,-1061486592,-1059127296 ,
    1094483968, 1093042176, 1091600384, 1089798144, 1086930944, 1084047360, 1080197120, 1074515968, 1061437440,-1089077248,-1074069504,-1068138496,-1063845888,-1060962304,-1058078720,-1056079872 ,
    1096450048, 1094746112, 1093042176, 1091338240, 1088765952, 1085358080, 1081769984, 1075056640, 1059274752,-1082785792,-1071284224,-1064910848,-1061486592,-1058078720,-1055817728,-1054113792 ,
    1098416128, 1096450048, 1094483968, 1092517888, 1090560000, 1086668800, 1082736640, 1075597312, 1057112064,-1079312384,-1068662784,-1063075840,-1059127296,-1056079872,-1054113792,-1052147712
  };

  fp8_matmul_simple(At, Bmat, C2, bias, VLEN); 

  for (int i = 0; i < VLEN; i ++) {
	for (int j = 0; j < VLEN; j ++) {
		int idx = i*VLEN + j;
		if (C2[idx] != CGold2[idx]) {
			printf("Mismatch at index %d. Expected %d, but got %d\n", idx, CGold2[idx], C2[idx]);
		}
	}
  }
  printf("Test Matmul done \n");
  return 0;
  }
