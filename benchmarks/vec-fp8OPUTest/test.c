
#include <stdio.h>
#include <riscv-pk/encoding.h>
#include <riscv_vector.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

// HACK reuse the scalar registers to avoid assembler hacking for now
#define m0 "x0"
#define m1 "x1"
#define m2 "x2"
#define m3 "x3"
#define m4 "x4"
#define m5 "x5"
#define m6 "x6"
#define m7 "x7"

#define v0 "x0"
#define v1 "x1"
#define v2 "x2"
#define v3 "x3"
#define v4 "x4"
#define v5 "x5"
#define v6 "x6"
#define v7 "x7"
#define v8 "x8"
#define v9 "x9"
#define v10 "x10"
#define v11 "x11"
#define v12 "x12"
#define v13 "x13"
#define v14 "x14"
#define v15 "x15"
#define v16 "x16"
#define v17 "x17"
#define v18 "x18"
#define v19 "x19"
#define v20 "x20"
#define v21 "x21"
#define v22 "x22"
#define v23 "x23"
#define v24 "x24"
#define v25 "x25"
#define v26 "x26"
#define v27 "x27"
#define v28 "x28"
#define v29 "x29"
#define v30 "x30"
#define v31 "x31"

#define VLEN 16
#define MIN 1
#define MAX 39
#define STEP 12

// opmvx. f6=b101010, f7=b1010101
#define OPMVIN(md, vs2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x55, " md ", %0, " vs2 : : "r"(rs1));

// opmvx. f6=b101110, f7=b1011101
#define OPMVOUT(vd, ms2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x5d, " vd ", %0, " ms2 : : "r"(rs1));

// opmvx. f6=b101100, f7=b1011001
#define OPMVINBCAST(md, vs2) \
  asm volatile(".insn r 0x57, 0x6, 0x59, " md ", x0, " vs2);

// opmvv. f6=b101000, f7=b1010001 
#define OPMACC(md, vs2, vs1) \
  asm volatile(".insn r 0x57, 0x2, 0x51, " md ", " vs1 ", " vs2);


void fp8_opu_simple(int8_t* vecA, int8_t* vecB, int32_t* result, size_t vec_size) {
	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
	asm volatile("vmv.v.i v0, 0x0");
	OPMVINBCAST(m1, v0);
	
	asm volatile("vsetvli %[vl], %[vl], e8, m1, ta, ma" : : [vl]"r"(vec_size));
        asm volatile("vle8.v v1, (%0)" : : "r"(vecA));
        asm volatile("vle8.v v0, (%0)" : : "r"(vecB));
        OPMACC(m1, v1, v0);

	asm volatile("vsetvli %[vl], %[vl], e32, m4, ta, ma" : : [vl]"r"(vec_size));
      	for (size_t r = 0; r < vec_size; r++) {
		OPMVOUT(v0, m1, r);
		asm volatile("vse32.v v0, (%0)" : : "r"(&result[r*vec_size]));
	}
}	

int main(void) {

  int8_t A[VLEN] = {-72, -74, -76, -78, -81, -85, -91, -103, 25, 37, 43, 47, 50, 52, 54, 56};
  int8_t B[VLEN] = {56, 54, 52, 50, 47, 43, 37, 25, -103, -91, -85, -81, -78, -76, -74, -72};
  int32_t C[VLEN*VLEN];
  int32_t CGold[VLEN*VLEN] = {
	   -1082130432, -1084227584, -1086324736, -1088421888, -1091567616, -1095761920, -1102053376, -1114636288, 1032847360, 1045430272, 1051721728, 1055916032, 1059061760, 1061158912, 1063256064, 1065353216,
   -1084227584, -1086062592, -1087897600, -1089732608, -1093533696, -1097203712, -1103757312, -1115947008, 1031536640, 1043726336, 1050279936, 1053949952, 1057751040, 1059586048, 1061421056, 1063256064,
   -1086324736, -1087897600, -1089470464, -1091567616, -1095499776, -1098645504, -1105461248, -1118306304, 1029177344, 1042022400, 1048838144, 1051983872, 1055916032, 1058013184, 1059586048, 1061158912,
   -1088421888, -1089732608, -1091567616, -1094189056, -1097465856, -1101266944, -1107165184, -1120665600, 1026818048, 1040318464, 1046216704, 1050017792, 1053294592, 1055916032, 1057751040, 1059061760,
   -1091567616, -1093533696, -1095499776, -1097465856, -1100939264, -1104871424, -1111293952, -1123614720, 1023868928, 1036189696, 1042612224, 1046544384, 1050017792, 1051983872, 1053949952, 1055916032,
   -1095761920, -1097203712, -1098645504, -1101266944, -1104871424, -1108213760, -1114701824, -1127874560, 1019609088, 1032781824, 1039269888, 1042612224, 1046216704, 1048838144, 1050279936, 1051721728,
   -1102053376, -1103757312, -1105461248, -1107165184, -1111293952, -1114701824, -1121386496, -1133903872, 1013579776, 1026097152, 1032781824, 1036189696, 1040318464, 1042022400, 1043726336, 1045430272,
   -1114636288, -1115947008, -1118306304, -1120665600, -1123614720, -1127874560, -1133903872, -1147011072, 1000472576, 1013579776, 1019609088, 1023868928, 1026818048, 1029177344, 1031536640, 1032847360,
   1032847360, 1031536640, 1029177344, 1026818048, 1023868928, 1019609088, 1013579776, 1000472576, -1147011072, -1133903872, -1127874560, -1123614720, -1120665600, -1118306304, -1115947008, -1114636288,
   1045430272, 1043726336, 1042022400, 1040318464, 1036189696, 1032781824, 1026097152, 1013579776, -1133903872, -1121386496, -1114701824, -1111293952, -1107165184, -1105461248, -1103757312, -1102053376,
   1051721728, 1050279936, 1048838144, 1046216704, 1042612224, 1039269888, 1032781824, 1019609088, -1127874560, -1114701824, -1108213760, -1104871424, -1101266944, -1098645504, -1097203712, -1095761920,
   1055916032, 1053949952, 1051983872, 1050017792, 1046544384, 1042612224, 1036189696, 1023868928, -1123614720, -1111293952, -1104871424, -1100939264, -1097465856, -1095499776, -1093533696, -1091567616,
   1059061760, 1057751040, 1055916032, 1053294592, 1050017792, 1046216704, 1040318464, 1026818048, -1120665600, -1107165184, -1101266944, -1097465856, -1094189056, -1091567616, -1089732608, -1088421888,
   1061158912, 1059586048, 1058013184, 1055916032, 1051983872, 1048838144, 1042022400, 1029177344, -1118306304, -1105461248, -1098645504, -1095499776, -1091567616, -1089470464, -1087897600, -1086324736,
   1063256064, 1061421056, 1059586048, 1057751040, 1053949952, 1050279936, 1043726336, 1031536640, -1115947008, -1103757312, -1097203712, -1093533696, -1089732608, -1087897600, -1086062592, -1084227584,
   1065353216, 1063256064, 1061158912, 1059061760, 1055916032, 1051721728, 1045430272, 1032847360, -1114636288, -1102053376, -1095761920, -1091567616, -1088421888, -1086324736, -1084227584, -1082130432
  };

  fp8_opu_simple(A, B, C, VLEN);

  for (int i = 0; i < VLEN; i ++) {
  	for (int j = 0; j < VLEN; j ++) {
		if (C[i*VLEN + j] != CGold[i*VLEN + j]) {
			printf("Mismatch at index %d.\n", i*VLEN + j);
		}
	}
  }

  printf("Test PASSED! \n");

  return 0;
  }
