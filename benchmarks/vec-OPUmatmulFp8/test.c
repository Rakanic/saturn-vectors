#include <stdio.h>
#include <riscv-pk/encoding.h>
#include <riscv_vector.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

// HACK reuse the scalar registers to avoid assembler hacking for now
#define m0 "x0"
#define m1 "x1"
#define m2 "x2"
#define m3 "x3"
#define m4 "x4"
#define m5 "x5"
#define m6 "x6"
#define m7 "x7"

#define v0 "x0"
#define v1 "x1"
#define v2 "x2"
#define v3 "x3"
#define v4 "x4"
#define v5 "x5"
#define v6 "x6"
#define v7 "x7"
#define v8 "x8"
#define v9 "x9"
#define v10 "x10"
#define v11 "x11"
#define v12 "x12"
#define v13 "x13"
#define v14 "x14"
#define v15 "x15"
#define v16 "x16"
#define v17 "x17"
#define v18 "x18"
#define v19 "x19"
#define v20 "x20"
#define v21 "x21"
#define v22 "x22"
#define v23 "x23"
#define v24 "x24"
#define v25 "x25"
#define v26 "x26"
#define v27 "x27"
#define v28 "x28"
#define v29 "x29"
#define v30 "x30"
#define v31 "x31"

// opmvx. f6=b101010, f7=b1010101
#define OPMVIN(md, vs2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x55, " md ", %0, " vs2 : : "r"(rs1));

// opmvx. f6=b101110, f7=b1011101
#define OPMVOUT(vd, ms2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x5d, " vd ", %0, " ms2 : : "r"(rs1));

// opmvx. f6=b101100, f7=b1011001
#define OPMVINBCAST(md, vs2) \
  asm volatile(".insn r 0x57, 0x6, 0x59, " md ", x0, " vs2);

// opmvv. f6=b101000, f7=b1010001
#define OPMACC(md, vs2, vs1) \
  asm volatile(".insn r 0x57, 0x2, 0x51, " md ", " vs1 ", " vs2);


void i32_init(int32_t* d, size_t s) {
  for (size_t i = 0; i < s; i++) d[i] = i + 1;
}

void i8_init(int8_t* d, size_t s) {
  for (size_t i = 0; i < s; i++) d[i] = i + 1;
}

int i32_compare(int32_t* a, int32_t* b, size_t s) {
  for (size_t i = 0; i < s; i++) {
    if (a[i] != b[i]) {
      printf("Divergence %d != %d index %ld\n", a[i], b[i], i);
      return 1;
    }
  }
  return 0;
}

void mm_scalar(int8_t* A, int8_t* B, int32_t* C, size_t M, size_t N, size_t K) {
  for (size_t m = 0; m < M; m++) {
    for (size_t n = 0; n < N; n++) {
      for (size_t k = 0; k < K; k++) {
        C[m*N+n] += A[M*k+m] * B[N*k+n];
      }
    }
  }
}

void mm_opu(int8_t* A, int8_t* B, int32_t* C, size_t M, size_t N, size_t K) {
  size_t maxvl;
  size_t vl;
  asm volatile("vsetvli %[vl], zero, e32, m4, ta, ma" : [vl]"=r"(maxvl));

  size_t i = 0;
  while (i < M) {
    size_t rows;
    asm volatile("vsetvli %[vl], %[avl], e8, m1, ta, ma" : [vl]"=r"(rows) : [avl]"r"(M-i));

    size_t j = 0;
    while (j < N) {
      // Clear the m1 tile
      asm volatile("vsetvli %[vl], x0, e32, m4, ta, ma" : [vl]"=r"(vl));
      asm volatile("vmv.v.i v0, 0x0");
      OPMVINBCAST(m1, v0);

      // Set rows/cols to remaining rows/cols using vsetvli
      size_t cols;
      asm volatile("vsetvli %[vl], %[avl], e8, m1, ta, ma" : [vl]"=r"(cols) : [avl]"r"(N-j));

      // do the k-loop
      for (size_t k = 0; k < K; k++) {
        asm volatile("vsetvli x0, %[avl], e8, m1, ta, ma" : : [avl]"r"(N-j));
        asm volatile("vle8.v v1, (%0)" : : "r"(&B[N*k+j]));
        asm volatile("vsetvli x0, %[avl], e8, m1, ta, ma" : : [avl]"r"(M-i));
        asm volatile("vle8.v v0, (%0)" : : "r"(&A[M*k+i]));
        OPMACC(m1, v1, v0);
      }

      // move row of c-tile to v-reg, accmulate wth c-row from memory, store back out
      asm volatile("vsetvli x0, %[avl], e32, m4, ta, ma" : : [avl]"r"(cols));
      for (size_t r = 0; r < rows; r++) {
        OPMVOUT(v0, m1, r);
        asm volatile("vle32.v v4, (%0)" : : "r"(&C[(i+r)*N+j]));
        asm volatile("vadd.vv v0, v0, v4");
        asm volatile("vse32.v v0, (%0)" : : "r"(&C[(i+r)*N+j]));
      }
      j += cols;
    }
    i += rows;
  }
}

#define VLEN 16
#define MIN 1
#define MAX 39
#define STEP 12

int main(void) {

	int8_t A[256] = {
		-72, -72, -72, -72, -73, -73, -73, -73, -73, -73, -73, -73, -74, -74, -74, -74,
		-74, -74, -74, -74, -75, -75, -75, -75, -75, -75, -75, -75, -76, -76, -76, -76,
		-76, -76, -76, -76, -77, -77, -77, -77, -77, -77, -77, -77, -78, -78, -78, -78,
		-78, -78, -78, -78, -79, -79, -79, -79, -79, -79, -79, -79, -80, -80, -80, -80,
		-80, -80, -81, -81, -81, -81, -82, -82, -82, -82, -83, -83, -83, -83, -84, -84,
		-84, -84, -85, -85, -85, -85, -86, -86, -86, -86, -87, -87, -87, -87, -88, -88,
		-88, -89, -89, -90, -90, -91, -91, -92, -92, -93, -93, -94, -94, -95, -95, -96,
		-96, -97, -98, -99, -100, -101, -102, -103, -105, -107, -109, -111, -114, -118, -122, -126,
		2,  6, 10, 14, 17, 19, 21, 23, 25, 26, 27, 28, 29, 30, 31, 32,
		32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40,
		40, 40, 41, 41, 41, 41, 42, 42, 42, 42, 43, 43, 43, 43, 44, 44,
		44, 44, 45, 45, 45, 45, 46, 46, 46, 46, 47, 47, 47, 47, 48, 48,
		48, 48, 48, 48, 49, 49, 49, 49, 49, 49, 49, 49, 50, 50, 50, 50,
		50, 50, 50, 50, 51, 51, 51, 51, 51, 51, 51, 51, 52, 52, 52, 52,
		52, 52, 52, 52, 53, 53, 53, 53, 53, 53, 53, 53, 54, 54, 54, 54,
		54, 54, 54, 54, 55, 55, 55, 55, 55, 55, 55, 55, 56, 56, 56, 56
	};

	int8_t B[256] = {
		56, 54, 52, 50, 48, 44, 40, 32, -126, -96, -88, -84, -80, -78, -76, -74,
		56, 54, 52, 50, 48, 44, 39, 31, -122, -95, -88, -84, -80, -78, -76, -74,
		56, 54, 52, 50, 47, 43, 39, 30, -118, -95, -87, -83, -80, -78, -76, -74,
		56, 54, 52, 50, 47, 43, 38, 29, -114, -94, -87, -83, -80, -78, -76, -74,
		55, 53, 51, 49, 47, 43, 38, 28, -111, -94, -87, -83, -79, -77, -75, -73,
		55, 53, 51, 49, 47, 43, 37, 27, -109, -93, -87, -83, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 37, 26, -107, -93, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 36, 25, -105, -92, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 36, 23, -103, -92, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 35, 21, -102, -91, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 45, 41, 35, 19, -101, -91, -85, -81, -79, -77, -75, -73,
		55, 53, 51, 49, 45, 41, 34, 17, -100, -90, -85, -81, -79, -77, -75, -73,
		54, 52, 50, 48, 45, 41, 34, 14, -99, -90, -85, -81, -78, -76, -74, -72,
		54, 52, 50, 48, 45, 41, 33, 10, -98, -89, -85, -81, -78, -76, -74, -72,
		54, 52, 50, 48, 44, 40, 33, 6,  -97, -89, -84, -80, -78, -76, -74, -72,
		54, 52, 50, 48, 44, 40, 32, 2,  -96, -88, -84, -80, -78, -76, -74, -72
	};

  int32_t C[VLEN*VLEN];
  int32_t C_gold[VLEN*VLEN] = {
	     -1052147712,-1054113792,-1056079872,-1059127296,-1063075840,-1068662784,-1079312384, 1057112064, 1075597312, 1082736640, 1086668800, 1090560000, 1092517888, 1094483968, 1096450048, 1098416128 ,
   -1054113792,-1055817728,-1058078720,-1061486592,-1064910848,-1071284224,-1082785792, 1059274752, 1075056640, 1081769984, 1085358080, 1088765952, 1091338240, 1093042176, 1094746112, 1096450048 ,
   -1056079872,-1058078720,-1060962304,-1063845888,-1068138496,-1074069504,-1089077248, 1061437440, 1074515968, 1080197120, 1084047360, 1086930944, 1089798144, 1091600384, 1093042176, 1094483968 ,
   -1059127296,-1061486592,-1063845888,-1067057152,-1071808512,-1079312384,-1101529088, 1063600128, 1073975296, 1078624256, 1082736640, 1085095936, 1087438848, 1089798144, 1091338240, 1092517888 ,
   -1063075840,-1064910848,-1068138496,-1071808512,-1077215232,-1086980096, 1042939904, 1065574400, 1073143808, 1077059584, 1080721408, 1083260928, 1085095936, 1086930944, 1088765952, 1090560000 ,
   -1068662784,-1071284224,-1074069504,-1079312384,-1086980096,-1112539136, 1057652736, 1066655744, 1072062464, 1075486720, 1078099968, 1080721408, 1082736640, 1084047360, 1085358080, 1086668800 ,
   -1079312384,-1082785792,-1089077248,-1101529088, 1042939904, 1057652736, 1063944192, 1067741184, 1070985216, 1073913856, 1075486720, 1077059584, 1078624256, 1080197120, 1081769984, 1082736640 ,
    1057112064, 1059274752, 1061437440, 1063600128, 1065574400, 1066655744, 1067741184, 1068798976, 1069914112, 1070985216, 1072062464, 1073143808, 1073975296, 1074515968, 1075056640, 1075597312 ,
    1075597312, 1075056640, 1074515968, 1073975296, 1073143808, 1072062464, 1070985216, 1069914112, 1068798976, 1067741184, 1066655744, 1065574400, 1063600128, 1061437440, 1059274752, 1057112064 ,
    1082736640, 1081769984, 1080197120, 1078624256, 1077059584, 1075486720, 1073913856, 1070985216, 1067741184, 1063944192, 1057652736, 1042939904,-1101529088,-1089077248,-1082785792,-1079312384 ,
    1086668800, 1085358080, 1084047360, 1082736640, 1080721408, 1078099968, 1075486720, 1072062464, 1066655744, 1057652736,-1112539136,-1086980096,-1079312384,-1074069504,-1071284224,-1068662784 ,
    1090560000, 1088765952, 1086930944, 1085095936, 1083260928, 1080721408, 1077059584, 1073143808, 1065574400, 1042939904,-1086980096,-1077215232,-1071808512,-1068138496,-1064910848,-1063075840 ,
    1092517888, 1091338240, 1089798144, 1087438848, 1085095936, 1082736640, 1078624256, 1073975296, 1063600128,-1101529088,-1079312384,-1071808512,-1067057152,-1063845888,-1061486592,-1059127296 ,
    1094483968, 1093042176, 1091600384, 1089798144, 1086930944, 1084047360, 1080197120, 1074515968, 1061437440,-1089077248,-1074069504,-1068138496,-1063845888,-1060962304,-1058078720,-1056079872 ,
    1096450048, 1094746112, 1093042176, 1091338240, 1088765952, 1085358080, 1081769984, 1075056640, 1059274752,-1082785792,-1071284224,-1064910848,-1061486592,-1058078720,-1055817728,-1054113792 ,
    1098416128, 1096450048, 1094483968, 1092517888, 1090560000, 1086668800, 1082736640, 1075597312, 1057112064,-1079312384,-1068662784,-1063075840,-1059127296,-1056079872,-1054113792,-1052147712
};

  //Test outer product
  size_t M = 16;
  size_t N = 16;
  size_t K = 16;
  mm_opu(A, B, C, M, N, K);
  for (size_t i = 0; i < M; i++) {
    for (size_t j = 0; j < N; j++) {
      if (C[i*N+j] != C_gold[i*N+j]) {
        printf("err r != gold %d != %d at (%d, %d)\n", C[i*N+j], C_gold[i*N+j], i, j);
      }
    }
  }

  printf("done\n");
  return 0;
  }

