#include <stdio.h>
#include <riscv-pk/encoding.h>
#include <riscv_vector.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

// HACK reuse the scalar registers to avoid assembler hacking for now
#define m0 "x0"
#define m1 "x1"
#define m2 "x2"
#define m3 "x3"
#define m4 "x4"
#define m5 "x5"
#define m6 "x6"
#define m7 "x7"

#define v0 "x0"
#define v1 "x1"
#define v2 "x2"
#define v3 "x3"
#define v4 "x4"
#define v5 "x5"
#define v6 "x6"
#define v7 "x7"
#define v8 "x8"
#define v9 "x9"
#define v10 "x10"
#define v11 "x11"
#define v12 "x12"
#define v13 "x13"
#define v14 "x14"
#define v15 "x15"
#define v16 "x16"
#define v17 "x17"
#define v18 "x18"
#define v19 "x19"
#define v20 "x20"
#define v21 "x21"
#define v22 "x22"
#define v23 "x23"
#define v24 "x24"
#define v25 "x25"
#define v26 "x26"
#define v27 "x27"
#define v28 "x28"
#define v29 "x29"
#define v30 "x30"
#define v31 "x31"

// opmvx. f6=b101010, f7=b1010101
#define OPMVIN(md, vs2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x55, " md ", %0, " vs2 : : "r"(rs1));

// opmvx. f6=b101110, f7=b1011101
#define OPMVOUT(vd, ms2, rs1) \
  asm volatile(".insn r 0x57, 0x6, 0x5d, " vd ", %0, " ms2 : : "r"(rs1));

// opmvx. f6=b101100, f7=b1011001
#define OPMVINBCAST(md, vs2) \
  asm volatile(".insn r 0x57, 0x6, 0x59, " md ", x0, " vs2);

// opmvv. f6=b101000, f7=b1010001
#define OPMACC(md, vs2, vs1) \
  asm volatile(".insn r 0x57, 0x2, 0x51, " md ", " vs1 ", " vs2);


void i32_init(int32_t* d, size_t s) {
  for (size_t i = 0; i < s; i++) d[i] = i + 1;
}

void i8_init(int8_t* d, size_t s) {
  for (size_t i = 0; i < s; i++) d[i] = i + 1;
}

int i32_compare(int32_t* a, int32_t* b, size_t s) {
  for (size_t i = 0; i < s; i++) {
    if (a[i] != b[i]) {
      printf("Divergence %d != %d index %ld\n", a[i], b[i], i);
      return 1;
    }
  }
  return 0;
}

void mm_scalar(int8_t* A, int8_t* B, int32_t* C, size_t M, size_t N, size_t K) {
  for (size_t m = 0; m < M; m++) {
    for (size_t n = 0; n < N; n++) {
      for (size_t k = 0; k < K; k++) {
        C[m*N+n] += A[M*k+m] * B[N*k+n];
      }
    }
  }
}

void mm_opu(int8_t* A, int8_t* B, int32_t* C, size_t M, size_t N, size_t K) {
  size_t maxvl;
  size_t vl;
  asm volatile("vsetvli %[vl], zero, e32, m4, ta, ma" : [vl]"=r"(maxvl));

  size_t i = 0;
  while (i < M) {
    size_t rows;
    asm volatile("vsetvli %[vl], %[avl], e8, m1, ta, ma" : [vl]"=r"(rows) : [avl]"r"(M-i));

    size_t j = 0;
    while (j < N) {
      // Clear the m1 tile
      asm volatile("vsetvli %[vl], x0, e32, m4, ta, ma" : [vl]"=r"(vl));
      asm volatile("vmv.v.i v0, 0x0");
      OPMVINBCAST(m1, v0);

      // Set rows/cols to remaining rows/cols using vsetvli
      size_t cols;
      asm volatile("vsetvli %[vl], %[avl], e8, m1, ta, ma" : [vl]"=r"(cols) : [avl]"r"(N-j));

      // do the k-loop
      for (size_t k = 0; k < K; k++) {
        asm volatile("vsetvli x0, %[avl], e8, m1, ta, ma" : : [avl]"r"(N-j));
        asm volatile("vle8.v v1, (%0)" : : "r"(&B[N*k+j]));
        asm volatile("vsetvli x0, %[avl], e8, m1, ta, ma" : : [avl]"r"(M-i));
        asm volatile("vle8.v v0, (%0)" : : "r"(&A[M*k+i]));
        OPMACC(m1, v1, v0);
      }

      // move row of c-tile to v-reg, accmulate wth c-row from memory, store back out
      asm volatile("vsetvli x0, %[avl], e32, m4, ta, ma" : : [avl]"r"(cols));
      for (size_t r = 0; r < rows; r++) {
        OPMVOUT(v0, m1, r);
        asm volatile("vle32.v v4, (%0)" : : "r"(&C[(i+r)*N+j]));
        asm volatile("vadd.vv v0, v0, v4");
        asm volatile("vse32.v v0, (%0)" : : "r"(&C[(i+r)*N+j]));
      }
      j += cols;
    }
    i += rows;
  }
}

#define VLEN 16
#define MIN 1
#define MAX 39
#define STEP 12

int main(void) {

	int8_t A[256] = {
		-72, -72, -72, -72, -73, -73, -73, -73, -73, -73, -73, -73, -74, -74, -74, -74,
		-74, -74, -74, -74, -75, -75, -75, -75, -75, -75, -75, -75, -76, -76, -76, -76,
		-76, -76, -76, -76, -77, -77, -77, -77, -77, -77, -77, -77, -78, -78, -78, -78,
		-78, -78, -78, -78, -79, -79, -79, -79, -79, -79, -79, -79, -80, -80, -80, -80,
		-80, -80, -81, -81, -81, -81, -82, -82, -82, -82, -83, -83, -83, -83, -84, -84,
		-84, -84, -85, -85, -85, -85, -86, -86, -86, -86, -87, -87, -87, -87, -88, -88,
		-88, -89, -89, -90, -90, -91, -91, -92, -92, -93, -93, -94, -94, -95, -95, -96,
		-96, -97, -98, -99, -100, -101, -102, -103, -105, -107, -109, -111, -114, -118, -122, -126,
		2,  6, 10, 14, 17, 19, 21, 23, 25, 26, 27, 28, 29, 30, 31, 32,
		32, 33, 33, 34, 34, 35, 35, 36, 36, 37, 37, 38, 38, 39, 39, 40,
		40, 40, 41, 41, 41, 41, 42, 42, 42, 42, 43, 43, 43, 43, 44, 44,
		44, 44, 45, 45, 45, 45, 46, 46, 46, 46, 47, 47, 47, 47, 48, 48,
		48, 48, 48, 48, 49, 49, 49, 49, 49, 49, 49, 49, 50, 50, 50, 50,
		50, 50, 50, 50, 51, 51, 51, 51, 51, 51, 51, 51, 52, 52, 52, 52,
		52, 52, 52, 52, 53, 53, 53, 53, 53, 53, 53, 53, 54, 54, 54, 54,
		54, 54, 54, 54, 55, 55, 55, 55, 55, 55, 55, 55, 56, 56, 56, 56
	};

	int8_t B[256] = {
		56, 54, 52, 50, 48, 44, 40, 32, -126, -96, -88, -84, -80, -78, -76, -74,
		56, 54, 52, 50, 48, 44, 39, 31, -122, -95, -88, -84, -80, -78, -76, -74,
		56, 54, 52, 50, 47, 43, 39, 30, -118, -95, -87, -83, -80, -78, -76, -74,
		56, 54, 52, 50, 47, 43, 38, 29, -114, -94, -87, -83, -80, -78, -76, -74,
		55, 53, 51, 49, 47, 43, 38, 28, -111, -94, -87, -83, -79, -77, -75, -73,
		55, 53, 51, 49, 47, 43, 37, 27, -109, -93, -87, -83, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 37, 26, -107, -93, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 36, 25, -105, -92, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 36, 23, -103, -92, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 46, 42, 35, 21, -102, -91, -86, -82, -79, -77, -75, -73,
		55, 53, 51, 49, 45, 41, 35, 19, -101, -91, -85, -81, -79, -77, -75, -73,
		55, 53, 51, 49, 45, 41, 34, 17, -100, -90, -85, -81, -79, -77, -75, -73,
		54, 52, 50, 48, 45, 41, 34, 14, -99, -90, -85, -81, -78, -76, -74, -72,
		54, 52, 50, 48, 45, 41, 33, 10, -98, -89, -85, -81, -78, -76, -74, -72,
		54, 52, 50, 48, 44, 40, 33, 6,  -97, -89, -84, -80, -78, -76, -74, -72,
		54, 52, 50, 48, 44, 40, 32, 2,  -96, -88, -84, -80, -78, -76, -74, -72
	};

  int32_t C[VLEN*VLEN];
  int32_t C_gold[VLEN*VLEN] = {
    -1050574848, -1052540928, -1054507008, -1056473088, -1059930112, -1063862272, -1070235648, -1082277888, 1064386560, 1077051392, 1083523072, 1087455232, 1090945024, 1092911104, 1094877184, 1096843264,
    -1052540928, -1054244864, -1055948800, -1058340864, -1061765120, -1065172992, -1071808512, -1084440576, 1062223872, 1075478528, 1082212352, 1085620224, 1089011712, 1091469312, 1093173248, 1094877184,
    -1054507008, -1055948800, -1057816576, -1060700160, -1063600128, -1067614208, -1073381376, -1086603264, 1060061184, 1073905664, 1079672832, 1083785216, 1086652416, 1089536000, 1091469312, 1092911104,
    -1056473088, -1058340864, -1060700160, -1063059456, -1065517056, -1070235648, -1076166656, -1088765952, 1057898496, 1070923776, 1077051392, 1081769984, 1084293120, 1086652416, 1089011712, 1090945024,
    -1059930112, -1061765120, -1063600128, -1065517056, -1069187072, -1072857088, -1079328768, -1091403776, 1054572544, 1067794432, 1074429952, 1078099968, 1081769984, 1083785216, 1085620224, 1087455232,
    -1063862272, -1065172992, -1067614208, -1070235648, -1072857088, -1077215232, -1082818560, -1095729152, 1050247168, 1063944192, 1069875200, 1074429952, 1077051392, 1079672832, 1082212352, 1083523072,
    -1070235648, -1071808512, -1073381376, -1076166656, -1079328768, -1082818560, -1089110016, -1101234176, 1043300352, 1057652736, 1063944192, 1067794432, 1070923776, 1073905664, 1075478528, 1077051392,
    -1082277888, -1084440576, -1086603264, -1088765952, -1091403776, -1095729152, -1101234176, -1112096768, 1026752512, 1043300352, 1050247168, 1054572544, 1057898496, 1060061184, 1062223872, 1064386560,
     1064386560, 1062223872, 1060061184, 1057898496, 1054572544, 1050247168, 1043300352, 1026752512, -1112096768, -1101234176, -1095729152, -1091403776, -1088765952, -1086603264, -1084440576, -1082277888,
     1077051392, 1075478528, 1073905664, 1070923776, 1067794432, 1063944192, 1057652736, 1043300352, -1101234176, -1089110016, -1082818560, -1079328768, -1076166656, -1073381376, -1071808512, -1070235648,
     1083523072, 1082212352, 1079672832, 1077051392, 1074429952, 1069875200, 1063944192, 1050247168, -1095729152, -1082818560, -1077215232, -1072857088, -1070235648, -1067614208, -1065172992, -1063862272,
     1087455232, 1085620224, 1083785216, 1081769984, 1078099968, 1074429952, 1067794432, 1054572544, -1091403776, -1079328768, -1072857088, -1069187072, -1065517056, -1063600128, -1061765120, -1059930112,
     1090945024, 1089011712, 1086652416, 1084293120, 1081769984, 1077051392, 1070923776, 1057898496, -1088765952, -1076166656, -1070235648, -1065517056, -1063059456, -1060700160, -1058340864, -1056473088,
     1092911104, 1091469312, 1089536000, 1086652416, 1083785216, 1079672832, 1073905664, 1060061184, -1086603264, -1073381376, -1067614208, -1063600128, -1060700160, -1057816576, -1055948800, -1054507008,
     1094877184, 1093173248, 1091469312, 1089011712, 1085620224, 1082212352, 1075478528, 1062223872, -1084440576, -1071808512, -1065172992, -1061765120, -1058340864, -1055948800, -1054244864, -1052540928,
     1096843264, 1094877184, 1092911104, 1090945024, 1087455232, 1083523072, 1077051392, 1064386560, -1082277888, -1070235648, -1063862272, -1059930112, -1056473088, -1054507008, -1052540928, -1050574848
};

  //Test outer product
  size_t M = 16;
  size_t N = 16;
  size_t K = 16;
  mm_opu(A, B, C, M, N, K);
  for (size_t i = 0; i < M; i++) {
    for (size_t j = 0; j < N; j++) {
      if (C[i*N+j] != C_gold[i*N+j]) {
        printf("err r != gold %d != %d at (%d, %d)\n", C[i*N+j], C_gold[i*N+j], i, j);
      }
    }
  }

  printf("done\n");
  return 0;
  }

